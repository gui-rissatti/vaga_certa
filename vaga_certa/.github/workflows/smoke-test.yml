name: Smoke Tests (Post-Deploy)

on:
  workflow_run:
    workflows: ["Backend CI/CD", "Frontend CI/CD"]
    types:
      - completed
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  smoke-test:
    name: E2E Smoke Test
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    environment: ${{ github.event.inputs.environment || 'production' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        cd backend
        pip install -r requirements.txt
        pip install -r requirements-test.txt
    
    - name: Wait for services to be ready
      run: |
        echo "Waiting 30s for services to warm up..."
        sleep 30
    
    - name: Run smoke tests
      env:
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        LANGCHAIN_TRACING_V2: false
        API_BASE_URL: ${{ secrets.PRODUCTION_BACKEND_URL }}
      run: |
        cd backend
        pytest ../tests/smoke/ -v -m smoke --timeout=120
    
    - name: Verify backend health
      run: |
        response=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.PRODUCTION_BACKEND_URL }}/health)
        if [ $response -ne 200 ]; then
          echo "âŒ Backend health check failed (HTTP $response)"
          exit 1
        fi
        echo "âœ… Backend is healthy"
    
    - name: Verify frontend accessibility
      run: |
        response=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.PRODUCTION_FRONTEND_URL }})
        if [ $response -ne 200 ]; then
          echo "âŒ Frontend health check failed (HTTP $response)"
          exit 1
        fi
        echo "âœ… Frontend is accessible"
    
    - name: Test critical endpoint (generate-complete)
      run: |
        cat > test_payload.json << EOF
        {
          "cv_text": "JoÃ£o Silva, Desenvolvedor Python com 5 anos de experiÃªncia. Habilidades: Python, FastAPI, Docker, AWS.",
          "job_url": "https://example.com/job",
          "tone": "professional",
          "language": "pt-BR"
        }
        EOF
        
        response=$(curl -s -o response.json -w "%{http_code}" \
          -X POST \
          -H "Content-Type: application/json" \
          -d @test_payload.json \
          ${{ secrets.PRODUCTION_BACKEND_URL }}/generate-complete \
          --max-time 120)
        
        if [ $response -ne 200 ]; then
          echo "âŒ Critical endpoint test failed (HTTP $response)"
          cat response.json
          exit 1
        fi
        
        # Valida estrutura da resposta
        if ! jq -e '.generated_content.optimized_cv' response.json > /dev/null; then
          echo "âŒ Response structure invalid"
          cat response.json
          exit 1
        fi
        
        echo "âœ… Critical endpoint test passed"
        
    - name: Report smoke test results
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "âœ… All smoke tests passed - Production is healthy!"
        else
          echo "âŒ Smoke tests failed - Production may have issues!"
        fi
    
    - name: Create issue on failure
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'ðŸš¨ Smoke Test Failed in Production',
            body: `
              ## Smoke Test Failure
              
              **Workflow:** ${context.workflow}
              **Run:** ${context.runNumber}
              **Commit:** ${context.sha}
              
              The post-deployment smoke tests have failed. 
              Please investigate immediately and consider rollback.
              
              [View workflow run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            `,
            labels: ['bug', 'production', 'urgent']
          })
    
    - name: Notify on success
      if: success()
      run: |
        echo "ðŸŽ‰ Smoke tests completed successfully!"
        echo "Production deployment validated."

  performance-check:
    name: Performance Check
    runs-on: ubuntu-latest
    needs: [smoke-test]
    if: success()
    
    steps:
    - name: Check backend response time
      run: |
        start_time=$(date +%s%N)
        curl -s ${{ secrets.PRODUCTION_BACKEND_URL }}/health > /dev/null
        end_time=$(date +%s%N)
        elapsed=$(( ($end_time - $start_time) / 1000000 ))
        
        echo "Backend response time: ${elapsed}ms"
        
        if [ $elapsed -gt 2000 ]; then
          echo "âš ï¸ Backend response time is slow (> 2s)"
        else
          echo "âœ… Backend response time is acceptable"
        fi
    
    - name: Check frontend load time
      run: |
        start_time=$(date +%s%N)
        curl -s ${{ secrets.PRODUCTION_FRONTEND_URL }} > /dev/null
        end_time=$(date +%s%N)
        elapsed=$(( ($end_time - $start_time) / 1000000 ))
        
        echo "Frontend load time: ${elapsed}ms"
        
        if [ $elapsed -gt 3000 ]; then
          echo "âš ï¸ Frontend load time is slow (> 3s)"
        else
          echo "âœ… Frontend load time is acceptable"
        fi

